#****************************************************************************
# Makefile for libminizip.so examples
#****************************************************************************
TLIBNAME := libminizip.so
EXENAME := test_minizip

# kdms prj path
BASETPRJDIR := ../../../../..
# base prj path
BASEPRJDIR := ../..

BASESRCDIR := ${BASEPRJDIR}/src
PUBLISHPATH := ${BASETPRJDIR}/lib/prj/comm/libminizip
TESTPATH := ${BASEPRJDIR}/bin

LIBEXPATH := 
EXLIBS := 

BASEDIR_SRCZLIB := ${BASESRCDIR}/zlib
BASEDIR_SRCMINIZIP := ${BASESRCDIR}/minizip

#****************************************************************************
# Source files
#****************************************************************************
CSRCS =  ${BASEDIR_SRCZLIB}/adler32.c
CSRCS += ${BASEDIR_SRCZLIB}/compress.c
CSRCS += ${BASEDIR_SRCZLIB}/crc32.c
CSRCS += ${BASEDIR_SRCZLIB}/deflate.c
CSRCS += ${BASEDIR_SRCZLIB}/gzclose.c
CSRCS += ${BASEDIR_SRCZLIB}/gzlib.c
CSRCS += ${BASEDIR_SRCZLIB}/gzread.c
CSRCS += ${BASEDIR_SRCZLIB}/gzwrite.c
CSRCS += ${BASEDIR_SRCZLIB}/infback.c
CSRCS += ${BASEDIR_SRCZLIB}/inffast.c
CSRCS += ${BASEDIR_SRCZLIB}/inflate.c
CSRCS += ${BASEDIR_SRCZLIB}/inftrees.c
CSRCS += ${BASEDIR_SRCZLIB}/trees.c
CSRCS += ${BASEDIR_SRCZLIB}/uncompr.c
CSRCS += ${BASEDIR_SRCZLIB}/zutil.c
CSRCS += ${BASEDIR_SRCMINIZIP}/zip.c
CSRCS += ${BASEDIR_SRCMINIZIP}/unzip.c
CSRCS += ${BASEDIR_SRCMINIZIP}/ioapi.c



SRCS   = ${BASESRCDIR}/minizip.cpp

TESTSRC := ${BASESRCDIR}/test_minizip.cpp
TESTSRC +:= ${BASESRCDIR}/minizip.cpp
TESTLIBOBJS := $(addsuffix .o,$(basename ${TESTSRC}))



CC     := gcc
CXX    := g++
LD     := g++
AR     := ar cr
RANLIB := ranlib

ADDDEF := 
DEBUG_CFLAGS     := -fPIC -Wall -Wno-format -g -DDEBUG ${ADDDEF}
RELEASE_CFLAGS   := -fPIC -Wall -Wno-unknown-pragmas -Wno-format -O3 ${ADDDEF}

LIBS		 :=

DEBUG_CXXFLAGS   := ${DEBUG_CFLAGS} 
RELEASE_CXXFLAGS := ${RELEASE_CFLAGS}

DEBUG_LDFLAGS    := -g
RELEASE_LDFLAGS  :=

ifeq (YES, ${LDEBUG})
   CFLAGS       := ${DEBUG_CFLAGS}
   CXXFLAGS     := ${DEBUG_CXXFLAGS}
   LDFLAGS      := ${DEBUG_LDFLAGS}
   LIBNAME      := ${TLIBNAME}
else
   CFLAGS       := ${RELEASE_CFLAGS}
   CXXFLAGS     := ${RELEASE_CXXFLAGS}
   LDFLAGS      := ${RELEASE_LDFLAGS}
   LIBNAME      := ${TLIBNAME}
endif

ifeq (YES, ${PROFILE})
   CFLAGS   := ${CFLAGS} -pg -O3
   CXXFLAGS := ${CXXFLAGS} -pg -O3
   LDFLAGS  := ${LDFLAGS} -pg
endif

DEFS := -D_LINUX_

INCS := -I${BASETPRJDIR}/include -I${BASETPRJDIR}/include/comm  -I${BASESRCDIR}/zlib  -I${BASESRCDIR}/minizip

#****************************************************************************
# Makefile code common to all platforms
#****************************************************************************

CFLAGS   := ${CFLAGS}   ${DEFS}
CXXFLAGS := ${CXXFLAGS} ${DEFS}

#****************************************************************************
# Targets of the build
#****************************************************************************

LIB := ${LIBNAME}

all: ${LIB} ${EXENAME}

# Add on the sources for libraries
CSRCS := ${CSRCS}
SRCS := ${SRCS}

CLIBOBJS := $(addsuffix .o,$(basename ${CSRCS}))
LIBOBJS := $(addsuffix .o,$(basename ${SRCS}))

#****************************************************************************
# Output
#****************************************************************************
${LIB}: ${CLIBOBJS} ${LIBOBJS} 
	$(CXX) -o $@ -shared ${CLIBOBJS} ${LIBOBJS} ${LIBEXPATH} ${EXLIBS}
	cp -rf $@ ${PUBLISHPATH}/$@
	cp -rf $@ ${TESTPATH}/$@

${EXENAME}: ${LIB} ${TESTLIBOBJS}
	$(CXX) -o $@ ${LIB}   -L. ${TESTLIBOBJS} ${LIBEXPATH} ${EXLIBS}
	cp -rf $@ ${TESTPATH}/$@

#****************************************************************************
# common rules
#****************************************************************************

# Rules for compiling source files to object files
%.o : %.c
	${CC} -c ${CFLAGS} ${INCS} $< -o $@

%.o : %.cpp
	${CXX} -c ${CXXFLAGS} ${INCS} $< -o $@

clean:
	-rm -f core ${CLIBOBJS} ${LIBOBJS} ${LIB} ${TESTLIBOBJS} ${EXENAME}
	
cleanobjs:
	-rm -f core ${CLIBOBJS} ${LIBOBJS} ${TESTLIBOBJS} ${LIB} ${EXENAME}

auto:
	make clean
	make all
	make cleanobjs
